Q1: How client connects to server? 

## Simple Explanation: WebSocket Connection Process

Think of WebSocket connection like upgrading a regular phone call to a video call. Here's how it works:

### Step 1: Client Sends HTTP Request (The Handshake)
```
Client → Server: "Hey, I want to upgrade to WebSocket!"
```

The client sends a special HTTP request with these headers:
- `Upgrade: websocket` - "I want to upgrade"
- `Connection: Upgrade` - "Switch the connection type"
- `Sec-WebSocket-Key: [random key]` - A secret key for security

**Example**: Client opens `ws://localhost:8089/ws` in browser or code

### Step 2: Server Upgrades the Connection
```
Server → Client: "OK! Connection upgraded!"
```

The server:
1. Checks if the request is valid
2. Computes a response key from the client's key
3. Switches from HTTP protocol to WebSocket protocol
4. Sends back: `HTTP 101 Switching Protocols` with `Sec-WebSocket-Accept`

**In Code** (line 141):
```go
conn, err := upgrader.Upgrade(w, r, nil)
```
This single line does the entire handshake!

### Step 3: Server Creates Client Object
```
Server creates: Client{ID, Connection, Send Channel, Subscriptions}
```

**In Code** (lines 148-153):
```go
client := &Client{
    ID:       uuid.New().String(),  // Give client a unique ID
    Conn:     conn,                  // Store the WebSocket connection
    Send:     make(chan []byte, 256), // Create mailbox for messages
    Channels: make(map[string]bool),  // Empty list of subscribed channels
}
```

### Step 4: Server Registers the Client
```
Server adds client to its list: "New client connected!"
```

**In Code** (line 156):
```go
s.register <- client  // Add to server's client list
```

The server now knows about this client and can send messages to it.

### Step 5: Server Sends Welcome Message
```
Server → Client: "Welcome! Your ID is abc-123"
```

**In Code** (lines 159-166):
```go
response := Response{
    ClientID: client.ID,  // "Here's your unique ID"
    Action:   "connect",
    Code:     200,
    Msg:      "success",
}
client.Send <- data  // Send it to the client
```

### Step 6: Start Reading and Writing
```
Server starts two background workers:
- One reads messages FROM client
- One writes messages TO client
```

**In Code** (lines 169-170):
```go
go s.writePump(client)  // Worker that sends messages
go s.readPump(client)   // Worker that receives messages
```

These run in separate goroutines (like separate threads) so they don't block each other.

---

## Visual Flow

```
┌─────────┐                    ┌─────────┐
│ Client  │                    │ Server  │
└────┬────┘                    └────┬────┘
     │                              │
     │  1. HTTP Request             │
     │  (with Upgrade headers)     │
     ├─────────────────────────────>│
     │                              │
     │                              │ 2. Upgrade Connection
     │                              │    (HTTP → WebSocket)
     │                              │
     │  3. HTTP 101 Switching       │
     │     Protocols                │
     │<─────────────────────────────┤
     │                              │
     │                              │ 4. Create Client Object
     │                              │    (ID, Connection, etc.)
     │                              │
     │                              │ 5. Register Client
     │                              │    (Add to server's list)
     │                              │
     │  6. Welcome Message          │
     │     {"clientId": "abc-123"}  │
     │<─────────────────────────────┤
     │                              │
     │                              │ 7. Start readPump & writePump
     │                              │    (Background workers)
     │                              │
     │  ✅ CONNECTED!               │
     │  (Now can send/receive)     │
     │                              │
```

---

## Key Points

1. **It starts as HTTP**: WebSocket connections begin with a regular HTTP request
2. **Upgrade happens once**: After upgrade, it's a persistent WebSocket connection
3. **Bidirectional**: Once connected, both client and server can send messages anytime
4. **Persistent**: Unlike HTTP (request-response), WebSocket stays open until closed
5. **Real-time**: Messages can be sent instantly without waiting for requests

---

## Real-World Analogy

**HTTP** = Like sending letters through mail (send → wait → receive response)

**WebSocket** = Like a phone call (connection stays open, both can talk anytime)

The "upgrade" is like switching from letters to a phone call - you make one initial call to establish the connection, then you can talk back and forth freely!
